<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>基盤・デプロイ自動化実践 &#8212; mynavi-doc-draft 1.0.0.SNAPSHOT ドキュメント</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="基盤・デプロイ自動化実践" href="automation_infra_devops_web_app_unittest.html" />
    <link rel="prev" title="基盤・デプロイ自動化実践" href="automation_infra_devops_micro_service_unittest-2.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          mynavi-doc-draft</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../table_of_contents_draft.html">記事目次案</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_overview.html">ソフトウェア開発自動化</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_actual_experience.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_sonarqube.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_sonarlint.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_micro_service_architecture.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_micro_service_unittest-1.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_micro_service_unittest-2.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_web_app_unittest.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_web_app_unit_e2e_test.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codebuild_local.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codebuild.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codepipeline_1.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codepipeline_2.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codepipeline_3.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codepipeline_4.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codepipeline_5.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codepipeline_6.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codepipeline_7.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codepipeline_8.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation_infra_devops_codepipeline_9.html">基盤・デプロイ自動化実践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-lambda-and-api-gateway-1.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-lambda-and-api-gateway-2.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-lambda-and-api-gateway-3.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-ecs-1.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-ecs-2.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-ecs-3.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-ecs-4.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-ecs-5.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-ecs-6.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-ecs-7.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-rds-1.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-rds-2.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-rds-3.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-1-1.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-1-2.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-2-1.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-2-2.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-2-3.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-3-1.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-3-2.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-3-3.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-4-1.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-4-2.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-4-3.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-4-4.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-4-5.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-nosql-4-6.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-s3-1.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-s3-2.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-s3-3.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-sqs-1.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-sqs-2.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-sqs-3.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_native/aws-sqs-4.html">AWSで作るクラウドネイティブアプリケーションの基本</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">基盤・デプロイ自動化実践</a><ul>
<li><a class="reference internal" href="#id2">マイクロサービスアーキテクチャの基盤・デプロイ自動化</a><ul>
<li><a class="reference internal" href="#section-integration-test-for-microservice-label">マイクロサービスにおける結合テスト</a></li>
<li><a class="reference internal" href="#servicerepository">Service⇔Repositoryの結合テスト実装</a></li>
<li><a class="reference internal" href="#controllerservicerepository">Controller⇔Service⇔Repositoryの結合テスト実装</a></li>
<li><a class="reference internal" href="#section-integration-test-strategy-for-microservice-label">マイクロサービスにおける結合テスト戦略と品質評価</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">著者紹介</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="automation_infra_devops_micro_service_unittest-2.html" title="Previous Chapter: 基盤・デプロイ自動化実践"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 基盤・デプロイ自動化実践</span>
    </a>
  </li>
  <li>
    <a href="automation_infra_devops_web_app_unittest.html" title="Next Chapter: 基盤・デプロイ自動化実践"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">基盤・デプロイ自動化実践 &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/automation_infra_devops/automation_infra_devops_micro_service_integrationtest.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="section-automation-infra-devops-microservice-integration-test-label">
<span id="id1"></span><h1>基盤・デプロイ自動化実践<a class="headerlink" href="#section-automation-infra-devops-microservice-integration-test-label" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="id2">
<h2>マイクロサービスアーキテクチャの基盤・デプロイ自動化<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><br/></p>
<div class="section" id="section-integration-test-for-microservice-label">
<span id="id3"></span><h3>マイクロサービスにおける結合テスト<a class="headerlink" href="#section-integration-test-for-microservice-label" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><br/></p>
<p>前回は、マイクロサービス(Backend)の単体テストの実装例や検証観点、テスト戦略のポイントを説明しました。
今回はバックエンドで実行されるマイクロサービスの結合テストです。アプリケーションおよびテストのパッケージ・コンポーネント構成は前回と同様、以下としています。</p>
<p><br/></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>backend<span class="o">]</span>
  └src
    ├main
    │ ├java
    │ │ └org
    │ │   └debugroom
    │ │     └mynavi
    │ │       └sample
    │ │         └continuous
    │ │           └integration
    │ │             └backend
    │ │               └app                                  ... アプリケーション層のパッケージ
    │ │               │ └model                              ... リクエストパラメータのモデルクラスパッケージ
    │ │               │ │ ├Xxxxx.java                       ... 入力チェックルール等が定義されるモデルクラス
    │ │               │ │ └XxxxxMapper.java                 ... ドメイン層のモデルクラスと相互変換するマッパークラス
    │ │               │ └web                                ... MvcConfigでコンポーネントスキャンの対象とするパッケージ
    │ │               │   └BackendRestController.java       ... リクエストハンドリング・ドメインサービス呼び出して、Resourceを返却するコントローラクラス
    │ │               └domain                               ... ドメイン層のパッケージ
    │ │               │ └model
    │ │               │ │ └entity                           ... JPAConfigでスキャン対象とするエンティティクラスパッケージ
    │ │               │ │   └Xxxxx.java                     ... JPAエンティティクラス
    │ │               │ ├repository                         ... JPAConfigでスキャン対象とするレポジトリクラスパッケージ
    │ │               │ │ ├specification                    ... JPAでテーブル結合等の条件を指定するクラスパッケージ
    │ │               │ │ │ └Xxxxx.java                     ... JPAでテーブル結合等の条件を指定するクラス
    │ │               │ │ └XxxxxRepository.java             ... レポジトリインタフェースクラス
    │ │               │ └service                            ... DomainConfigでコンポーネントスキャンの対象とするサービスクラスパッケージ
    │ │               │   ├SampleService.java               ... DBへ基本的なCRUDアクセスを行うサービスインタフェースクラス
    │ │               │   ├SampleServiceImpl.java           ... SampleServiceの実装クラス
    │ │               │   ├SampleOneToOneService.java       ... <span class="m">1</span>対1の関連をもつテーブルアクセスを行うサービスインタフェースクラス
    │ │               │   ├SampleOneToOneServiceImpl.java   ... SampleOneToOneServiceの実装クラス
    │ │               │   ├SampleOneToManyService.java      ... <span class="m">1</span>対多の関連をもつテーブルアクセスを行うサービスインタフェースクラス
    │ │               │   ├SampleOneToManyServiceImpl.java  ... SampleOneToOneServiceの実装クラス
    │ │               │   ├SampleManyToManyService.java     ... 多対多の関連をもつテーブルアクセスを行うサービスインタフェースクラス
    │ │               │   └SampleManyToManyServiceImpl.java ... サービス実装クラス
    │ │               └config                               ... 設定クラス用のパッケージ
    │ │                   ├App.java                         ... アプリケーション起動クラス
    │ │                   ├DevConfig.java                   ... 開発環境固有の設定クラス
    │ │                   ├DomainConfig.java                ... ドメイン層に関する設定クラス
    │ │                   ├JPAConfig.java                   ... JPA設定クラス
    │ │                   └MvcConfig.java                   ... アプリケーション層に関する設定クラス
    │ └resources
    │   ├application.yml                                    ... アプリケーション設定ファイル
    │   └application-dev.yml                                ... プロファイル<span class="s2">&quot;dev&quot;</span>で有効になるアプリケーション設定ファイル
    <span class="nb">test</span>                                                    ... テストパッケージフォルダ
      ├java
      │ └org
      │   └debugroom
      │     └mynavi
      │       └sample
      │         └continuous
      │           └integration
      │             └backend
      │               ├app
      │               │ └web
      │               │   └BackendRestControllerTest.java   ... Controllerのテストクラス
      │               ├domain
      │               │ ├DataJpaTestConfig.java             ... Repositoryのテスト設定クラス
      │               │ ├repository                         ... Repositoryテストパッケージ
      │               │ │ └XxxxRepositoryTest.java          ... Repositoryのテストクラス
      │               │ └service                            ... Serviceテストパッケージ
      │               │   └XxxxServiceTest.java             ... Serviceのテストクラス
      │               └config
      │                 └TestConfig.java                    ... Testの汎用設定クラス
      └resources
        ├META-INF
        │ └dbunit                                           ... DBUnitのテーブルデータ用パッケージ
        │   └domain
        │     └service
        │       └XxxxServiceTest                            ... テストクラスごとのフォルダ
        │         └Xxxx                                     ... テストケースごとのフォルダ
        │           ├Xxxxx.csv                              ... 各テーブルのテストデータ
        │           └table-ordering.txt                     ... 読み込み対象のテーブル名を記載したテキストファイル
        └application.yml                                    ... テスト用のアプリケーション設定ファイル
</pre></div>
</div>
<p><br/></p>
<p>各コンポーネントは <a class="reference external" href="http://terasolunaorg.github.io/guideline/5.5.1.RELEASE/ja/Overview/ApplicationLayering.html#id9">TERASOLUNAのガイドライン レイヤの依存関係</a> を基本的に踏襲していますが、Controller→Service→Repositoryという単方向の呼び出ししかありません。
そのため、結合試験としては、下記のイメージ通り、Service→Repositoryおよび、Controller→Service→Repositoryといった順に積み上げ式で試験を進めることにします(Repositoryをスタブ化し、ControllerとServiceのみの結合試験は除外できます)。</p>
<p><br/></p>
<div class="figure">
<img alt="../_images/microservice-integrationtest-scope.png" src="../_images/microservice-integrationtest-scope.png" />
</div>
<p><br/></p>
<p>各テストの観点は以下の通りです。コンポーネントの内部構造は意識せず、ブラックボックス的に処理実行後のIOやデータベース反映結果を中心に検証します。</p>
<p><br/></p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="15%" />
<col width="15%" />
<col width="15%" />
<col width="55%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>アプリケーション</td>
<td>試験</td>
<td>コンポーネント</td>
<td>検証観点</td>
</tr>
<tr class="row-even"><td>マイクロサービス <br/> (Backend)</td>
<td>結合試験</td>
<td>Service⇔Repository</td>
<td>・データベースから正しく値が取得できるか <br/> ・データベースへ正しくデータが反映できるか <br/> ・設定ファイルが正しく動作するか</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>&#160;</td>
<td>Controller⇔Service⇔Repository</td>
<td>・期待したレスポンスが返却されるか <br/> ・モデル間のデータマッピングが正しく実行されているか <br/> ・設定ファイルが正しく動作するか</td>
</tr>
</tbody>
</table>
<p><br/></p>
</div>
<div class="section" id="servicerepository">
<span id="section-service-repository-integration-test-for-microservice-label"></span><h3>Service⇔Repositoryの結合テスト実装<a class="headerlink" href="#servicerepository" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><br/></p>
<p>データベースからの基本的なデータ取得については、Repositoryの単体テストで妥当性確認はとれているので、データベースへの更新結果を中心にDBUnitを用いて検証します(複雑な条件のデータ取得は処理結合レベルでバリエーションテストを実施した方がよりベターです)。
また、Serviceの単体でも分岐条件などで発生するビジネスエラーや設定されるメッセージの確認はとれているので、ServiceがRepositoryを正しく呼び出すことができるか、
プロパティなどの設定が正しく動作するかを&#64;SpringBootTestアノテーションを使って、SpringBootApplicationを起動した場合のように検証します。
Serviceクラスを起点としたサンプル結合テストコードは以下の通りです。</p>
<p><br/></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.mynavi.sample.continuous.integration.backend.domain.service</span><span class="o">;</span>

<span class="c1">// omit</span>
<span class="kn">import</span> <span class="nn">com.github.springtestdbunit.DbUnitTestExecutionListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.springtestdbunit.annotation.DbUnitConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.springtestdbunit.annotation.ExpectedDatabase</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.springtestdbunit.annotation.ExpectedDatabases</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.springtestdbunit.assertion.DatabaseAssertionMode</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.springtestdbunit.dataset.AbstractDataSetLoader</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.dbunit.dataset.IDataSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.dbunit.dataset.csv.CsvDataSet</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.TestExecutionListeners</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.support.DependencyInjectionTestExecutionListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.support.DirtiesContextTestExecutionListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.transaction.TransactionalTestExecutionListener</span><span class="o">;</span>

<span class="c1">// omit</span>

<span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>                                                 <span class="c1">// …(A)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="o">{</span>
      <span class="n">TestConfig</span><span class="o">.</span><span class="na">ServiceTestConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
<span class="o">},</span> <span class="n">webEnvironment</span> <span class="o">=</span>  <span class="n">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span>                     <span class="c1">// …(B)</span>
<span class="nd">@TestExecutionListeners</span><span class="o">({</span> <span class="n">DependencyInjectionTestExecutionListener</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
      <span class="n">DirtiesContextTestExecutionListener</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
      <span class="n">TransactionalTestExecutionListener</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
      <span class="n">DbUnitTestExecutionListener</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>                                   <span class="c1">// …(C)</span>
<span class="nd">@DbUnitConfiguration</span><span class="o">(</span><span class="n">dataSetLoader</span> <span class="o">=</span> <span class="n">IntegrationTest</span><span class="o">.</span><span class="na">CsvDataSetLoader</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// …(D)</span>
<span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">&quot;dev&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">IntegrationTest</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CsvDataSetLoader</span> <span class="kd">extends</span> <span class="n">AbstractDataSetLoader</span><span class="o">{</span>  <span class="c1">// …(E)</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">IDataSet</span> <span class="nf">createDataSet</span><span class="o">(</span><span class="n">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CsvDataSet</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getFile</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// omit</span>

    <span class="nd">@Autowired</span>
    <span class="n">SampleService</span> <span class="n">sampleService</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@ExpectedDatabases</span><span class="o">({</span>                                                       <span class="c1">// …(F)</span>
          <span class="nd">@ExpectedDatabase</span><span class="o">(</span>
                  <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;classpath:/META-INF/dbunit/domain/service/SampleServiceImplTest/add&quot;</span><span class="o">,</span>
                  <span class="n">table</span> <span class="o">=</span> <span class="s">&quot;usr&quot;</span><span class="o">,</span> <span class="n">assertionMode</span> <span class="o">=</span> <span class="n">DatabaseAssertionMode</span><span class="o">.</span><span class="na">NON_STRICT</span><span class="o">),</span>
          <span class="nd">@ExpectedDatabase</span><span class="o">(</span>
                  <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;classpath:/META-INF/dbunit/domain/service/SampleServiceImplTest/add&quot;</span><span class="o">,</span>
                  <span class="n">table</span> <span class="o">=</span> <span class="s">&quot;address&quot;</span><span class="o">,</span> <span class="n">assertionMode</span> <span class="o">=</span> <span class="n">DatabaseAssertionMode</span><span class="o">.</span><span class="na">NON_STRICT</span><span class="o">),</span>
          <span class="nd">@ExpectedDatabase</span><span class="o">(</span>
                  <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;classpath:/META-INF/dbunit/domain/service/SampleServiceImplTest/add&quot;</span><span class="o">,</span>
                  <span class="n">table</span> <span class="o">=</span> <span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="n">assertionMode</span> <span class="o">=</span> <span class="n">DatabaseAssertionMode</span><span class="o">.</span><span class="na">NON_STRICT_UNORDERED</span><span class="o">),</span>
          <span class="nd">@ExpectedDatabase</span><span class="o">(</span>
                  <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;classpath:/META-INF/dbunit/domain/service/SampleServiceImplTest/add&quot;</span><span class="o">,</span>
                  <span class="n">table</span> <span class="o">=</span> <span class="s">&quot;membership&quot;</span><span class="o">,</span> <span class="n">assertionMode</span> <span class="o">=</span> <span class="n">DatabaseAssertionMode</span><span class="o">.</span><span class="na">NON_STRICT_UNORDERED</span><span class="o">),</span>
    <span class="o">})</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addNormalTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">BusinessException</span><span class="o">{</span>
        <span class="c1">// omit</span>
        <span class="n">User</span> <span class="n">addUser</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
              <span class="o">.</span><span class="na">firstName</span><span class="o">(</span><span class="s">&quot;saburo&quot;</span><span class="o">)</span>
              <span class="o">.</span><span class="na">familyName</span><span class="o">(</span><span class="s">&quot;mynavi&quot;</span><span class="o">)</span>
              <span class="o">.</span><span class="na">loginId</span><span class="o">(</span><span class="s">&quot;saburo.mynavi&quot;</span><span class="o">)</span>
              <span class="o">.</span><span class="na">isLogin</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
              <span class="o">.</span><span class="na">addressByUserId</span><span class="o">(</span><span class="n">addAddress</span><span class="o">)</span>
              <span class="o">.</span><span class="na">emailsByUserId</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="n">Email</span><span class="o">[]{</span><span class="n">addEmail1</span><span class="o">,</span> <span class="n">addEmail2</span><span class="o">}))</span>
              <span class="o">.</span><span class="na">membershipsByUserId</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="n">Membership</span><span class="o">[]{</span><span class="n">membership1</span><span class="o">}))</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
       <span class="n">sampleService</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addUser</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
<p><br/></p>
<table border="1" class="colwidths-given docutils" id="id7">
<caption><span class="caption-text">Service⇔Repositoryの結合テストコードの説明</span><a class="headerlink" href="#id7" title="このテーブルへのパーマリンク">¶</a></caption>
<colgroup>
<col width="5%" />
<col width="95%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>項番</td>
<td>説明</td>
</tr>
<tr class="row-even"><td><ol class="first last upperalpha simple">
<li></li>
</ol>
</td>
<td>テストランナーとして、SpringRunnerを指定します。</td>
</tr>
<tr class="row-odd"><td><ol class="first last upperalpha simple" start="2">
<li></li>
</ol>
</td>
<td>&#64;SpringBootTestアノテーションには、テスト向け固有の設定クラスを任意に指定し、Controllerを介さない場合、Webコンテナ(Server)を起動しないオプションを指定しておきます。</td>
</tr>
<tr class="row-even"><td><ol class="first last upperalpha simple" start="3">
<li></li>
</ol>
</td>
<td>DBUnitで使用するTestExecutionListenerの設定を行います。ここでは詳しい説明は割愛しますが、詳細は <a class="reference external" href="http://terasolunaorg.github.io/guideline/5.5.1.RELEASE/ja/UnitTest/ImplementsOfUnitTest/UsageOfLibraryForTest.html#usageoflibraryfortestregistrationoftestexecutionlistener">TERASOLUNAガイドライン TestExecutionListenerの登録</a> を参照してください。</td>
</tr>
<tr class="row-odd"><td><ol class="first last upperalpha simple" start="4">
<li></li>
</ol>
</td>
<td>テストに使うデータベースへのデータ設定にはCSV形式のデータファイルを使用します。なお、データはExcel形式でもできますが、実行パフォーマンスの問題やコードコミット時にバイナリファイルで差分比較ができなくなるためCSVの方がベターです。詳細は <a class="reference external" href="http://terasolunaorg.github.io/guideline/5.5.1.RELEASE/ja/UnitTest/ImplementsOfUnitTest/PreparationForTest.html#spring-test-dbunit">テストデータのセットアップ</a> を参照してください。</td>
</tr>
<tr class="row-even"><td><ol class="first last upperalpha simple" start="5">
<li></li>
</ol>
</td>
<td>CSV形式でデータロードするための拡張クラスです。</td>
</tr>
<tr class="row-odd"><td><ol class="first last upperalpha simple" start="6">
<li></li>
</ol>
</td>
<td>テストメソッド実行後に期待するデータベースのデータを各テーブルごとに設定します。詳細は <a class="reference external" href="http://terasolunaorg.github.io/guideline/5.5.1.RELEASE/ja/UnitTest/ImplementsOfUnitTest/ImplementsOfTestByLayer.html#spring-test-dbunit">Spring Test DBUnitを利用したテスト</a> も参照してください。</td>
</tr>
</tbody>
</table>
<p><br/></p>
<p>サンプルとして実装したテストケースと検証観点は以下になります。テストケースの順序をうまく設定すること(AddしてからFindAllする)でトランザクションの有効化なども合わせて、処理結合テストレベルで検証するようにしています。
なお、下記のように、プロファイル&quot;dev&quot;で有効化する設定クラスを作成し、データベースおよびテストデータは事前にHSQLなどのインメモリDBに設定しておきます。</p>
<p><br/></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.mynavi.sample.continuous.integration.backend.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Profile</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.embedded.EmbeddedDatabaseBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.embedded.EmbeddedDatabaseType</span><span class="o">;</span>

<span class="nd">@Profile</span><span class="o">(</span><span class="s">&quot;dev&quot;</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DevConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">DataSource</span> <span class="nf">dataSource</span><span class="o">(){</span>
        <span class="k">return</span> <span class="o">(</span><span class="k">new</span> <span class="n">EmbeddedDatabaseBuilder</span><span class="o">())</span>
          <span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="n">EmbeddedDatabaseType</span><span class="o">.</span><span class="na">HSQL</span><span class="o">)</span>
          <span class="o">.</span><span class="na">addScript</span><span class="o">(</span><span class="s">&quot;classpath:ddl/schema.sql&quot;</span><span class="o">)</span>
          <span class="o">.</span><span class="na">addScript</span><span class="o">(</span><span class="s">&quot;classpath:ddl/data.sql&quot;</span><span class="o">)</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><br/></p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="35%" />
<col width="30%" />
<col width="35%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>ユースケース</td>
<td>主な処理実装クラス・メソッド <br/> テストメソッド</td>
<td>検証観点</td>
</tr>
<tr class="row-even"><td>[正常系]ユーザを追加する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleServiceImpl.java#L52">SampleService#add</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleServiceImplTest.java#L348">SampleServiceTest#addNormalTest()</a></td>
<td>・データベースへ正しくデータが反映できるか</td>
</tr>
<tr class="row-odd"><td>[正常系]ユーザを検索する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleServiceImpl.java#L35">SampleService#findOne</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleServiceImplTest.java#L375">SampleServiceTest#findOneNormalTest()</a></td>
<td>・データベースから正しく値が取得できるか <br/> ・(Autowiredインジェクション等)設定が正しいか</td>
</tr>
<tr class="row-even"><td>[正常系]全ユーザを検索する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleServiceImpl.java#L47">SampleService#findAll</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleServiceImplTest.java#L382">SampleServiceTest#findAllNormalTest()</a></td>
<td>・(トランザクション)設定が正しいか</td>
</tr>
<tr class="row-odd"><td>[正常系]ユーザを更新する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleServiceImpl.java#L98">SampleService#update</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleServiceImplTest.java#L404">SampleServiceTest#updateNormalTest()</a></td>
<td>・データベースへ正しくデータが反映できるか(想定した部分以外まで更新されていないか)</td>
</tr>
<tr class="row-even"><td>[正常系]ユーザを削除する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleServiceImpl.java#L145">SampleService#delete</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleServiceImplTest.java#L447">SampleServiceTest#deleteNormalTest()</a></td>
<td>・データベースへ正しくデータが反映できるか(想定した部分以外まで削除されていないか)</td>
</tr>
<tr class="row-odd"><td>[正常系]指定したユーザの住所を取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImpl.java#L33">SampleOneToOneService#findAddressOf</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImplTest.java#L168">SampleOneToOneServiceTest#findAddressOfNormalTest()</a></td>
<td>・データベースから正しく値が取得できるか <br/> ・(Autowiredインジェクション等)設定が正しいか</td>
</tr>
<tr class="row-even"><td>[正常系]指定した郵便番号の住所をもつユーザを取得する(1)</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImpl.java#L45">SampleOneToOneService#findUserHavingAddressOfZipCode</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImplTest.java#L175">SampleOneToOneServiceTest#findUserHavingAddressOfZipCodeNormalTest1()</a></td>
<td>・データベースから正しく値が取得できるか</td>
</tr>
<tr class="row-odd"><td>[正常系]指定した郵便番号の住所をもつユーザを取得する(2)</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImpl.java#L45">SampleOneToOneService#findUserHavingAddressOfZipCode</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImplTest.java#L184">SampleOneToOneServiceTest#findUserHavingAddressOfZipCodeNormalTest2()</a></td>
<td>・データベースから正しく値が取得できるか</td>
</tr>
<tr class="row-even"><td>[正常系]指定した郵便番号の住所をもたないユーザを取得する(1)</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImpl.java#L45">SampleOneToOneService#findUserHavingAddressOfZipCode</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImplTest.java#L175">SampleOneToOneServiceTest#findUserHavingAddressOfZipCodeNormalTest1()</a></td>
<td>・データベースから正しく値が取得できるか</td>
</tr>
<tr class="row-odd"><td>[正常系]指定した郵便番号の住所をもたないユーザを取得する(2)</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImpl.java#L45">SampleOneToOneService#findUserHavingAddressOfZipCode</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImplTest.java#L184">SampleOneToOneServiceTest#findUserHavingAddressOfZipCodeNormalTest2()</a></td>
<td>・データベースから正しく値が取得できるか</td>
</tr>
<tr class="row-even"><td>[正常系]住所を更新する。</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImpl.java#L57">SampleOneToOneService#update</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToOneServiceImplTest.java#L213">SampleOneToOneServiceTest#updateTestNormal()</a></td>
<td>・データベースへ正しくデータが反映できるか(想定した部分以外まで削除されていないか)</td>
</tr>
<tr class="row-odd"><td>[正常系]指定したユーザのメールリストを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImpl.java#L38">SampleOneToManyService#getEmailsOf</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImplTest.java#L202">SampleOneToManyServiceTest#getEmailsOfNormalTest()</a></td>
<td>・データベースから正しく値が取得できるか <br/> ・(Autowiredインジェクション等)設定が正しいか</td>
</tr>
<tr class="row-even"><td>[正常系]メールを追加する。</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImpl.java#L55">SampleOneToManyService#add</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImplTest.java#L217">SampleOneToManyServiceTest#addNormalTest()</a></td>
<td>・データベースへ正しくデータが反映できるか</td>
</tr>
<tr class="row-odd"><td>[正常系]メールを更新する。</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImpl.java#L74">SampleOneToManyService#update</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImplTest.java#L236">SampleOneToManyServiceTest#updateNormalTest()</a></td>
<td>・データベースへ正しくデータが反映できるか(想定した部分以外まで更新されていないか)</td>
</tr>
<tr class="row-even"><td>[正常系]メールを削除する(1)。</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImpl.java#L92">SampleOneToManyService#delete</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImplTest.java#L251">SampleOneToManyServiceTest#deleteNormalTest1()</a></td>
<td>・データベースへ正しくデータが反映できるか(想定した部分以外まで削除されていないか)</td>
</tr>
<tr class="row-odd"><td>[正常系]メールを削除する(2)。</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImpl.java#L92">SampleOneToManyService#delete</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImplTest.java#L265">SampleOneToManyServiceTest#deleteNormalTest2()</a></td>
<td>・データベースへ正しくデータが反映できるか(想定した部分以外まで削除されていないか)</td>
</tr>
<tr class="row-even"><td>[正常系]全てのメールを削除する。</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImpl.java#L122">SampleOneToManyService#deleteAll</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleOneToManyServiceImplTest.java#L279">SampleOneToManyServiceTest#deleteAllNormalTest()</a></td>
<td>・データベースへ正しくデータが反映できるか(想定した部分以外まで削除されていないか)</td>
</tr>
<tr class="row-odd"><td>[正常系]ユーザが所属するグループを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImpl.java#L40">SampleManyToManyService#getGroupOf</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImplTest.java#L186">SampleManyToManyServiceTest#getGroupOfUserNormalTest()</a></td>
<td>・データベースから正しく値が取得できるか <br/> ・(Autowiredインジェクション等)設定が正しいか</td>
</tr>
<tr class="row-even"><td>[正常系]指定したグループに所属するユーザを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImpl.java#L46">SampleManyToManyService#getUserOf</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImplTest.java#L198">SampleManyToManyServiceTest#getUserOfGroupNormalTest()</a></td>
<td>・データベースから正しく値が取得できるか</td>
</tr>
<tr class="row-odd"><td>[正常系]指定したグループに所属しないユーザを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImpl.java#L52">SampleManyToManyService#getUserOfNot</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImplTest.java#L208">SampleManyToManyServiceTest#getUserOfNotGroupNormalTest()</a></td>
<td>・データベースから正しく値が取得できるか</td>
</tr>
<tr class="row-even"><td>[正常系]指定したグループにユーザを追加する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImpl.java#L58">SampleManyToManyService#addUserTo</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImplTest.java#L223">SampleManyToManyServiceTest#addUserToGroupNormalTest()</a></td>
<td>・データベースへ正しくデータが反映できるか</td>
</tr>
<tr class="row-odd"><td>[正常系]指定したグループからユーザを削除する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImpl.java#L86">SampleManyToManyService#deleteUserFrom</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImplTest.java#L235">SampleManyToManyServiceTest#deleteUserFromGroupNormalTest()</a></td>
<td>・データベースへ正しくデータが反映できるか(想定した部分以外まで削除されていないか)</td>
</tr>
<tr class="row-even"><td>[正常系]指定したグループを削除する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImpl.java#L109">SampleManyToManyService#delete</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/domain/service/SampleManyToManyServiceImplTest.java#L250">SampleManyToManyServiceTest#deleteGroupNormalTest()</a></td>
<td>・データベースへ正しくデータが反映できるか(想定した部分以外まで削除されていないか)</td>
</tr>
</tbody>
</table>
<p><br/></p>
</div>
<div class="section" id="controllerservicerepository">
<span id="section-controller-service-repository-integration-test-for-microservice-label"></span><h3>Controller⇔Service⇔Repositoryの結合テスト実装<a class="headerlink" href="#controllerservicerepository" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><br/></p>
<p>Controller⇔Service⇔Repositoryの結合テストでは、実際にアプリケーションを起動した時と同様、HTTPリクエストを送信し、期待したHTTPレスポンスが返ってくるか検証します。
データベースへの反映結果は前節のService⇔Repositoryで確認が取れているので、Service実行後のアウトプットが期待した通り、HTTPレスポンスに変換されるか、モデルのデータマッピングが正しく実行されているか、アプリケーションの設定が正しく動作するかといった点が主な観点になります。
Controllerクラスを起点とした結合テストサンプルコードは以下の通りです。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.debugroom.mynavi.sample.continuous.integration.backend.app.web</span><span class="o">;</span>

<span class="c1">// omit</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.web.client.TestRestTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.web.server.LocalServerPort</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="o">;</span>

<span class="c1">// omit</span>

<span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>                                      <span class="c1">// …(A)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="n">TestConfig</span><span class="o">.</span><span class="na">ControllerTestConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
   <span class="n">webEnvironment</span> <span class="o">=</span> <span class="n">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">RANDOM_PORT</span><span class="o">)</span>    <span class="c1">// …(B)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">IntegrationTest</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">testServer</span> <span class="o">=</span> <span class="s">&quot;localhost&quot;</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">TestRestTemplate</span> <span class="n">testRestTemplate</span><span class="o">;</span>                           <span class="c1">// …(C)</span>

    <span class="nd">@LocalServerPort</span>
    <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>                                                    <span class="c1">// …(D)</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">testServerURL</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">(){</span>
        <span class="n">testServerURL</span> <span class="o">=</span> <span class="s">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">testServer</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">port</span><span class="o">;</span>     <span class="c1">// …(E)</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getUsersNormalTest</span><span class="o">(){</span>
        <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">UserResource</span><span class="o">[]&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span> <span class="n">testRestTemplate</span>
          <span class="o">.</span><span class="na">getForEntity</span><span class="o">(</span><span class="n">testServerURL</span> <span class="o">+</span> <span class="s">&quot;/api/v1/users&quot;</span><span class="o">,</span> <span class="n">UserResource</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserResource</span><span class="o">&gt;</span> <span class="n">userResources</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">responseEntity</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">userResources</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">userResources</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">userResource</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">userResource</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())){</span>
                <span class="k">case</span> <span class="s">&quot;1&quot;</span><span class="o">:</span>
                    <span class="n">assertThat</span><span class="o">(</span><span class="n">userResource</span><span class="o">.</span><span class="na">getFirstName</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;hanako&quot;</span><span class="o">));</span>
                    <span class="n">assertThat</span><span class="o">(</span><span class="n">userResource</span><span class="o">.</span><span class="na">getFamilyName</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;mynavi&quot;</span><span class="o">));</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="c1">// omit</span>
            <span class="o">}</span>
        <span class="o">});</span>

   <span class="o">}</span>
</pre></div>
</div>
<p><br/></p>
<table border="1" class="colwidths-given docutils" id="id8">
<caption><span class="caption-text">Controller⇔Service⇔Repositoryの結合テストコードの説明</span><a class="headerlink" href="#id8" title="このテーブルへのパーマリンク">¶</a></caption>
<colgroup>
<col width="5%" />
<col width="95%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>項番</td>
<td>説明</td>
</tr>
<tr class="row-even"><td><ol class="first last upperalpha simple">
<li></li>
</ol>
</td>
<td>テストランナーとして、SpringRunnerを指定します。</td>
</tr>
<tr class="row-odd"><td><ol class="first last upperalpha simple" start="2">
<li></li>
</ol>
</td>
<td>&#64;SpringBootTestアノテーションには、テスト向け固有の設定クラスを任意に指定し、Webコンテナ(Server)の起動時のポートをランダムで指定しておきます。</td>
</tr>
<tr class="row-even"><td><ol class="first last upperalpha simple" start="3">
<li></li>
</ol>
</td>
<td>起動したテストアプリケーションに対して、リクエストを送信するTestRestTemplateをインジェクションします。</td>
</tr>
<tr class="row-odd"><td><ol class="first last upperalpha simple" start="4">
<li></li>
</ol>
</td>
<td>(B)でランダム指定したポートを取得します。</td>
</tr>
<tr class="row-even"><td><ol class="first last upperalpha simple" start="5">
<li></li>
</ol>
</td>
<td>セットアップメソッドで、HTTPリクエストを送信するテストサーバURLを作成します。</td>
</tr>
</tbody>
</table>
<p><br/></p>
<p>サンプルとして実装したテストケースと検証観点は以下になります。異常系のバリエーションは単体テストで検証しているため、
基本的には、エラー時のHTTPレスポンス生成が正しく実行されるかといった点のみを検証しています。</p>
<p><br/></p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="35%" />
<col width="30%" />
<col width="35%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>ユースケース</td>
<td>主な処理実装クラス・メソッド <br/> テストメソッド</td>
<td>検証観点</td>
</tr>
<tr class="row-even"><td>[正常系]ユーザの一覧を取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L53">BackendController#getUsers</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L578">BackendControllerTest#getUsersNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか  <br/> ・設定ファイルが正しく動作するか</td>
</tr>
<tr class="row-odd"><td>[正常系]ユーザを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L58">BackendController#getUser</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L605">BackendControllerTest#getUserNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか <br/> <br/> ・モデル間のデータマッピングが正しく実行されているか</td>
</tr>
<tr class="row-even"><td>[異常系]ユーザを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L58">BackendController#getUser</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L622">BackendControllerTest#getUserAbnormalTest()</a></td>
<td>・期待したレスポンスが返却されるか(エラー)</td>
</tr>
<tr class="row-odd"><td>[正常系]ユーザを追加する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L65">BackendController#addUser</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L636">BackendControllerTest#addUserNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-even"><td>[正常系]ユーザを更新する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L74">BackendController#updateUser</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L675">BackendControllerTest#updateUserNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-odd"><td>[正常系]ユーザを削除する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L82">BackendController#deleteUser</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L718">BackendControllerTest#deleteUserNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-even"><td>[正常系]指定したログインIDを持つユーザを検索する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L89">BackendController#findUserOfLoginId</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L737">BackendControllerTest#findUserOfLoginIdNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-odd"><td>[正常系]指定したユーザの住所を取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L97">BackendController#findAddressOfUser</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L752">BackendControllerTest#findAddressOfUserNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか <br/> <br/> ・モデル間のデータマッピングが正しく実行されているか</td>
</tr>
<tr class="row-even"><td>[正常系]指定した郵便番号の住所を持つユーザを検索する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L104">BackendController#findUsersHavingAddressOfZipCode</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L766">BackendControllerTest#findUsersHavingAddressOfZipCodeNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-odd"><td>[正常系]指定した郵便番号の住所を持たないユーザを検索する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L111">BackendController#findUsersNotHavingAddressOfZipCode</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L789">BackendControllerTest#findUsersNotHavingAddressOfZipCodeNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-even"><td>[正常系]住所を更新する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L118">BackendController#updateAddress</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L809">BackendControllerTest#updateAddressNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-odd"><td>[正常系]指定したユーザのメールアドレスリストを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L125">BackendController#findEmailsOfUser</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L831">BackendControllerTest#findEmailsOfUserNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか <br/> <br/> ・モデル間のデータマッピングが正しく実行されているか</td>
</tr>
<tr class="row-even"><td>[正常系]指定したメールアドレスをもつユーザを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L132">BackendController#findUserHavingEmail</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L851">BackendControllerTest#findUserHavingEmailNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-odd"><td>[正常系]メールアドレスを追加する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L139">BackendController#addEmail</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L869">BackendControllerTest#addEmailNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-even"><td>[正常系]メールアドレスを更新する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L146">BackendController#updateEmail</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L890">BackendControllerTest#updateEmailNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-odd"><td>[正常系]メールアドレスを削除する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L153">BackendController#deleteEmail</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L912">BackendControllerTest#deleteEmailNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-even"><td>[正常系]ユーザが所属するグループを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L167">BackendController#findGroupsOfUser</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L932">BackendControllerTest#findGroupsOfUserNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか <br/> <br/> ・モデル間のデータマッピングが正しく実行されているか</td>
</tr>
<tr class="row-odd"><td>[正常系]指定したグループに所属するユーザを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L173">BackendController#findUsersOfGroup</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L952">BackendControllerTest#findUsersOfGroupNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-even"><td>[正常系]指定したグループに所属しないユーザを取得する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L179">BackendController#findUsersOfNotGroup</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L972">BackendControllerTest#findUsersOfNotGroupNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-odd"><td>[正常系]ユーザを指定したグループに追加する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L185">BackendController#addUserToGroup</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L995">BackendControllerTest#addUserToGroupNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-even"><td>[正常系]ユーザを指定したグループから削除する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L194">BackendController#deleteUserFromGroup</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L1009">BackendControllerTest#deleteUserFromGroupNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
<tr class="row-odd"><td>[正常系]グループを削除する</td>
<td><a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/main/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendContoller.java#L203">BackendController#deleteGroup</a>  <br/> <br/>  <a class="reference external" href="https://github.com/debugroom/mynavi-sample-continuous-integration/blob/master/backend/src/test/java/org/debugroom/mynavi/sample/continuous/integration/backend/app/web/BackendControllerTest.java#L1021">BackendControllerTest#deleteGroupNormalTest()</a></td>
<td>・期待したレスポンスが返却されるか</td>
</tr>
</tbody>
</table>
<p><br/></p>
</div>
<div class="section" id="section-integration-test-strategy-for-microservice-label">
<span id="id5"></span><h3>マイクロサービスにおける結合テスト戦略と品質評価<a class="headerlink" href="#section-integration-test-strategy-for-microservice-label" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><br/></p>
<p>(1)Service⇔Repository、(2)Controller⇔Service⇔Repositoryの結合テストコード実装を解説してきました。単体テストと似通った試験を実施しても非効率になりますので、効率的な結合テスト戦略策定のポイントとしては、</p>
<ul class="simple">
<li>コンポーネントの内部構造は意識せず、ブラックボックス的に処理実行後のInputOutputやデータベース反映結果を中心に検証する。</li>
<li>テストケースの順序をうまく設定すること(AddしてからFindAllするなど)でトランザクションの有効化なども合わせて、処理結合テストレベルで検証する。</li>
<li>探索的テストを導入し、実装状況に応じてテストケースの重複を極力減らしながらテストコードを作成する</li>
<li>機能や処理の重要度に応じて、テスト実施内容に濃淡をつける(ビジネス的にそこまで重要でない処理の参照系はテストしない等)</li>
</ul>
<p>テストクラスの量を増やしたくないのであれば、(1)を除外して、(2)で(1)のテスト観点を含めて検証しても問題ありません。
テスト品質は、ユースケース数に対するテストケースの割合、テストケースの定性的評価などを加えつつ評価するとよいでしょう。</p>
<p><br/></p>
<p>次回は引き続き、マイクロサービスを呼び出すWebアプリケーションにおいて、単体テストコードをSpringBootでどのように実装するか、解説していきます。</p>
<p><br/></p>
</div>
</div>
<div class="section" id="id6">
<h2>著者紹介<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>川畑 光平(KAWABATA Kohei) - NTTデータ 課長代理</p>
<div class="figure">
<img alt="../_images/pic_image01.jpg" src="../_images/pic_image01.jpg" />
</div>
<p>金融機関システム業務アプリケーション開発・システム基盤担当を経て、現在はソフトウェア開発自動化関連の研究開発・推進に従事。</p>
<p>Red Hat Certified Engineer、Pivotal Certified Spring Professional、AWS Certified Solutions Architect Professional等の資格を持ち、アプリケーション基盤・クラウドなど様々な開発プロジェクト支援にも携わる。</p>
<p><a class="reference external" href="https://aws.amazon.com/jp/blogs/psa/japan-apn-ambassador-2019/">2019 APN AWS Top Engineers &amp; Ambassadors</a> 選出。</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018, kohei.kawabata.<br/>
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6 で生成しました。<br/>
    </p>
  </div>
</footer>
  </body>
</html>